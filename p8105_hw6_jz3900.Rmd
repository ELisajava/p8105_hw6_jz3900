---
title: "p8105_hw6_jz3900"
author: "ELisajava"
date: "2024-12-03"
output: github_document
---

## Load Necessary Libraries and Set Seed
```{r}
options(repos = c(CRAN = "https://cloud.r-project.org/"))
install.packages("broom")
library(broom)
library(tidyverse)
library(p8105.datasets)
library(patchwork)
library(forcats)
library(modelr)
library(mgcv)
set.seed(1)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```


# Problem 2 
## Import and organize data
```{r}
homicide_data = read_csv("data/homicide-data.csv") |>
  janitor::clean_names() |> 
  mutate(city_state = paste(city, state, sep = ", "),
         resolved = ifelse(disposition == "Closed by arrest", 1, 0),
         victim_race = str_to_lower(victim_race),
         victim_age_clean = as.numeric(gsub("[^0-9]", "", victim_age))) |> 
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"),
    victim_race %in% c("white", "black")
  ) |> 
  mutate(victim_age = victim_age_clean) |> 
  select(-victim_age_clean)  
```

## Run Logistic Regression Analysis for Solving Homicides in Baltimore, MD
```{r}
baltimore_data = homicide_data |> 
  filter(city_state == "Baltimore, MD")

baltimore_model = glm(resolved ~ victim_age + victim_sex + victim_race, 
                       data = baltimore_data, family = binomial())

baltimore_results = broom::tidy(baltimore_model, conf.int = TRUE, exponentiate = TRUE)

baltimore_or = baltimore_results |> 
  filter(term == "victim_sexMale") |> 
  select(term, estimate, conf.low, conf.high) |> 
  rename(
    `Comparison` = term,
    `Adjusted Odds Ratio` = estimate,
    `Lower 95% CI` = conf.low,
    `Upper 95% CI` = conf.high
  )

baltimore_or |> 
  knitr::kable(caption = "Adjusted Odds Ratio for Male vs Female Victims (Baltimore)") 
```

## Estimation and Presentation of Adjusted Odds Ratios for Male vs Female Victims by City
```{r}
city_results = homicide_data |> 
  group_by(city) |> 
  nest() |> 
  mutate(
    models = map(data, \(df) glm(resolved ~ victim_age + victim_sex + victim_race, 
                             data = df, family = binomial())),
    tidy_results = map(models, \(model) broom::tidy(model, conf.int = TRUE, exponentiate = TRUE))
  ) |> 
  unnest(tidy_results) |> 
  filter(term == "victim_sexMale") |> 
  select(city, estimate, conf.low, conf.high) 

city_results |> 
  knitr::kable(
    col.names = c(
      "City", 
      "Adjusted Odds Ratio", 
      "Lower 95% CI", 
      "Upper 95% CI"
    ),
    caption = "Adjusted Odds Ratio for Male vs Female Victims by City"
  )
```

## Visualization of Estimated Odds Ratios and Confidence Intervals by City
```{r}
city_results |> 
  ggplot(aes(y = reorder(city, estimate), x = estimate)) + 
    geom_point(color = "blue") +
    geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.25) +  
    labs(
      title = "Adjusted Odds Ratios for Solving Homicides (Male vs Female Victims)",
      x = "Adjusted Odds Ratio (95% CI)",
      y = "City"
    )
```

**Description**:

1. **Cities with OR < 1:**  
Male victims are less likely to have their cases resolved in cities where the odds ratio (OR) is below 1. Notable examples include New York and Baton Rouge, which appear near the lower end of the plot.  

2. **Cities with OR > 1:**  
A limited number of cities, such as Albuquerque and Stockton, exhibit ORs greater than 1. This indicates that male victims in these cities may have a higher likelihood of their cases being resolved compared to female victims. However, the wide confidence intervals (CIs) associated with these ORs highlight significant uncertainty in the estimates.  

3. **Cities with Wide CIs:**  
Cities like Albuquerque, NM, and Stockton, CA, display notably wide confidence intervals, which reflect either high variability or insufficient data in these locations. Such uncertainty makes it challenging to draw definitive conclusions about the ORs in these cities.  

4. **Statistical Significance:**  
Cities where the confidence intervals do not include OR = 1 demonstrate statistically significant differences (e.g., New York). Conversely, cities with confidence intervals that overlap OR = 1 are not statistically significant, indicating no definitive evidence of a difference in resolution rates between male and female victims.  